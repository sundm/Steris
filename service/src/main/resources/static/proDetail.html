<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>会员管理</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="all,follow">
    <!-- Bootstrap CSS-->
    <link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.min.css">
    <!-- Font Awesome CSS-->
    <link rel="stylesheet" href="vendor/font-awesome/css/font-awesome.min.css">
    <!-- Fontastic Custom icon font-->
    <link rel="stylesheet" href="css/fontastic.css">
    <!-- Google fonts - Roboto -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700">
    <!-- jQuery Circle-->
    <link rel="stylesheet" href="css/grasp_mobile_progress_circle-1.0.0.min.css">
    <!-- Custom Scrollbar-->
    <link rel="stylesheet" href="vendor/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.css">
    <!-- theme stylesheet-->
    <link rel="stylesheet" href="css/style.default.css" id="theme-stylesheet">
    <!-- Custom stylesheet - for your changes-->
    <link rel="stylesheet" href="css/custom.css">
    <!-- Favicon-->
    <link rel="shortcut icon" href="img/favicon.ico">
    <!-- Tweaks for older IEs--><!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]-->
  </head>
  <style>
    .line-limit-length {
      max-width: 110px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .table{
      width: 100%;
    }
    .con-img{
      width: 30%;
      text-align: center;
    }
    .con-text{
      width: 200px;
    }
    .title{
      text-align: right;
    }
    .table input{
      border: 0px;
      width: 100%;
      height: 35px;
    }
    #addTr{
      text-align: center;
    }
    #foot{
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid silver;
      width: 100%;
      text-align: center;
    }
  </style>
  <body>
    <!-- Side Navbar -->
    <nav class="side-navbar">
      <div id="menu-import"></div>
    </nav>
    <div class="page">
      <!-- navbar-->
      <header class="header">
        <nav class="navbar">
          <div class="container-fluid">
            <div class="navbar-holder d-flex align-items-center justify-content-between">
              <div class="navbar-header"><a href="index.html" class="navbar-brand">
                <div class="brand-text d-none d-md-inline-block"><span>简洁&nbsp;</span><strong class="text-primary">高效</strong></div></a></div>
              <ul class="nav-menu list-unstyled d-flex flex-md-row align-items-md-center">
                <!-- Log out-->
                <li class="nav-item"><a href="login.html" class="nav-link logout"> <span class="d-none d-sm-inline-block">Logout</span><i class="fa fa-sign-out"></i></a></li>
              </ul>
            </div>
          </div>
        </nav>
      </header>
      <!-- Breadcrumb-->
      <div class="breadcrumb-holder">
        <div class="container-fluid">
          <ul class="breadcrumb">
            <li class="breadcrumb-item"><a href="index.html">Home</a></li>
            <li class="breadcrumb-item active">Tables</li>
          </ul>
        </div>
      </div>
      <section>
        <div class="container-fluid">
          <!-- Page Header-->
          <header></header>
          <div class="row">
            <div class="col-lg-12">
              <div class="card">
                <div class="card-header">
                  <h4>编辑文章</h4>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <form id="form" enctype="multipart/form-data">
                    <table class="table">
                      <tr>
                        <!-- 预览部分 -->
                        <td class="con-img">
                          预览
                        </td>
                        <!-- 编辑部分 -->
                        <td class="con-text">
                          <table class="valTable">
                            <tr>
                              <td class="title">文章标题：</td>
                              <td colspan="2">
                                <input type="text" class="newsTitle">
                              </td>
                            </tr>
                            <tr>
                              <td class="title">文章简介：</td>
                              <td colspan="2">
                                <textarea  class="newsText" type="text" cols="100%" rows="3px"></textarea>
                              </td>
                            </tr>
                            <tr>
                              <td class="title">封面图片：</td>
                              <td colspan="2">
                                <input class="newsImg" type='file' name="files" multiple='multiple' accept='image/*'/>
                                <div style='display: none;' id="newsImgName"></div>" ;
                              </td>
                            </tr>
                            <tbody class="addTable"></tbody>
                          </table>
                        </td>

                      </tr>
                    </table>
                    </form>
                    <div id="addTr">
                      <button class="addText btn btn-default">添加文字</button>
                      <button class="addImg btn btn-default">添加图片</button>
                    </div>
                    <!-- foot -->
                    <div id="foot">
                      <button class="addSubmit btn btn-primary" data-toggle='modal' data-target='#myModal'>提交</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!--计数-->
      <input id="addNum" type="number" value="0" style="display: none;">
      <!-- 模态框（Modal） -->
      <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 id="exampleModalLabel" class="modal-title">确认操作</h5>
              <button type="button" data-dismiss="modal" aria-label="Close" class="close"><span aria-hidden="true">×</span></button>
            </div>
            <div class="modal-body">
              确认新增文章！
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">关闭
              </button>
              <button type="button" class="btn btn-primary" data-dismiss="modal" id="submit">
                提交更改
              </button>
            </div>
          </div><!-- /.modal-content -->
        </div><!-- /.modal -->
      </div>
      <!-- /.modal -->
    </div>
    <!-- JavaScript files-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/popper.js/umd/popper.min.js"> </script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="js/grasp_mobile_progress_circle-1.0.0.min.js"></script>
    <script src="vendor/jquery.cookie/jquery.cookie.js"> </script>
    <script src="vendor/chart.js/Chart.min.js"></script>
    <script src="vendor/jquery-validation/jquery.validate.min.js"></script>
    <script src="vendor/malihu-custom-scrollbar-plugin/jquery.mCustomScrollbar.concat.min.js"></script>
    <!-- Main File-->
    <script src="js/front.js"></script>
    <script src="js/url.js"></script>
    <!-- script -->
    <script>
      $("#menu-import").load("menu.html");
      $("#top-import").load("top.html");
      $(function () {
          $("#newsImgName").html(random(9));
      })
      /*
      * 追加文字
      * */
      $(".addText").on("click",function () {
          var num = $("#addNum").val();
          var tr ="<tr>" ;
          tr = tr+"<td class='title'>文字段落：</td>" ;
          tr = tr+"<td class=''><textarea type='text' cols='100%' rows='3px'></textarea></td>" ;
          tr = tr+"<td><button class='remove btn btn-default'>移除</button></td>" ;
          tr = tr+"<td style='display: none;'>"+num+"</td>" ;
          tr = tr+"<td style='display: none;'>2</td>" ;
          tr = tr+"</tr>";
          $(".addTable").append(tr);
          $("#addNum").val(Number(num)+1)
      })
      /*
      * 追加图片
      * */
      $(".addImg").on("click",function () {
          var num = $("#addNum").val();
          var tr ="<tr>" ;
          tr = tr+"<td class='title'>图片段落：</td>" ;
          tr = tr+"<td class=''><input type='file' name='files' multiple='multiple' accept='image/*'/></td>" ;
          tr = tr+"<td><button class='remove btn btn-default'>移除</button></td>" ;
          tr = tr+"<td style='display: none;'>"+num+"</td>" ;
          tr = tr+"<td style='display: none;'>1</td>" ;
          tr = tr+"<td style='display: none;'>"+random(9)+"</td>" ;
          tr = tr+"</tr>";
          $(".addTable").append(tr);
          $("#addNum").val(Number(num)+1)
      })
      /*
      * 移除指定追加项
      * */
      $(".addTable").on('click','.remove',function(){
          $(this).parent().parent().remove();
      })
      /*
      * 提交信息
      * */
      $("#submit").click(function () {
          var type = "files";
          var formData = new FormData();//这里需要实例化一个FormData来进行文件上传
          /*获取*/
          var news = [];
          $('.addTable tr').each(function(i){
              var text;
              if ($(this).find('td:eq(4)').html()=='2') {
                  text = $(this).find('td:eq(1) textarea').val();
              }else {
                  var imgFile = $(this).find('td:eq(1) input')[0].files[0];
                  var addFile = resetFile(imgFile,$(this).find('td:eq(5)').html());
                  formData.append("files",addFile);
                  text = addFile.name;
              }
              var seq = $(this).find('td:eq(3)').html();
              var type = $(this).find('td:eq(4)').html();
              var tr ={
                  "text":text,
                  "seq":Number(seq),
                  "type":type
              };
              news[i]=tr;
          });
          var jsonData = {
              "newsTitle":$(".newsTitle").val(),
              "newsText":$(".newsText").val(),
              "newsImg":resetFile($(".newsImg")[0].files[0],$("#newsImgName").html()).name,
              "news":news
          };
          formData.append(type,resetFile($(".newsImg")[0].files[0],$("#newsImgName").html()));
          $.ajax({
              url:globalURL+"news/add",
              type:"POST",
              dataType:"json",
              contentType: "application/json;charset=utf-8",
              data:JSON.stringify(jsonData),
              async : false,
              success:function(data){
                  if (data.code=="9000"){
                      $.ajax({
                          type : "post",
                          url : globalURL+"news/uploadToFile",
                          data : formData,
                          processData : false,
                          contentType : false,
                          async : false,
                          success : function(data) {
                              console.log(data)
                          }
                      });
                      alert("success.")
                  }else {
                      alert("fail.")
                  }
              }
          })
      })
    </script>
  </body>
</html>